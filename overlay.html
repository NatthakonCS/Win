<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Smart Color Overlay</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body {
            background-color: transparent !important;
            margin: 0; padding: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: flex-start;
            height: 100vh;
        }
        .overlay-container {
            font-family: 'Poppins', sans-serif;
            font-size: 120px; font-weight: 900;
            -webkit-text-stroke: 3px black; 
            text-shadow: 5px 5px 0px #000000;
            line-height: 1; padding-left: 10px;
        }

        /* --- กำหนดสี --- */
        .color-white  { color: #ffffff; } 
        .color-green  { color: #00ff2a; } 
        .color-red    { color: #ff0040; } 
        
        /* เพิ่มสีเหลืองสำหรับ Target */
        .color-yellow { color: #e7eb0c; } 

        .pop { animation: pop 0.2s ease-in-out; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="overlay-container" id="container">
        <span id="displayWins" class="color-white">0</span><span class="color-white">/</span><span id="displayTarget" class="color-yellow">5</span>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        const ROOM_TOPIC = 'coolkris_room_999'; 
        const MQTT_HOST = 'wss://broker.emqx.io:8084/mqtt';
        
        const clientId = 'overlay_' + Math.random().toString(16).substr(2, 8);
        const displayWins = document.getElementById('displayWins');
        const displayTarget = document.getElementById('displayTarget');
        const container = document.getElementById('container');
        const audioPlayer = document.getElementById('audioPlayer');
        
        const client = mqtt.connect(MQTT_HOST, { clientId: clientId, clean: true });

        client.on('connect', () => {
            console.log("Connected Overlay");
            client.subscribe(ROOM_TOPIC);
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                const currentWinVal = parseInt(data.wins);
                
                // --- ตรรกะเปลี่ยนสี Wins (เหมือนเดิม) ---
                displayWins.classList.remove('color-green', 'color-red', 'color-white');

                if (currentWinVal > 0) {
                    displayWins.classList.add('color-green');
                } else if (currentWinVal < 0) {
                    displayWins.classList.add('color-red');
                } else {
                    displayWins.classList.add('color-white');
                }

                if (displayWins.innerText != data.wins) {
                    displayWins.innerText = data.wins;
                    container.classList.remove('pop');
                    void container.offsetWidth; 
                    container.classList.add('pop');
                }
                
                displayTarget.innerText = data.target;

                if (data.playSound === 'win' && data.soundWin) {
                    playAudio(data.soundWin);
                } else if (data.playSound === 'lose' && data.soundLose) {
                    playAudio(data.soundLose);
                }

            } catch (e) { console.error(e); }
        });

        function playAudio(url) {
            audioPlayer.src = url;
            audioPlayer.volume = 0.8; 
            audioPlayer.play().catch(e => console.log("Sound error:", e));
        }
    </script>
</body>
</html>
