<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
</head>
<body>

<div class="dashboard-container">
    <h1>üéõÔ∏è Ultimate Control</h1>
    
    <div style="text-align: center; margin-bottom: 10px;">
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="statusText" style="color: orange;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
    </div>

    <div class="card settings">
        <h2>üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå Overlay</h2>
        <div style="display: flex; gap: 5px; margin-top: 5px;">
            <input type="text" id="overlayLinkInput" readonly style="font-size: 0.9rem; color: #aaa;">
            <button id="btnCopy" class="btn btn-primary" style="padding: 10px 15px; font-size: 0.9rem;">Copy</button>
        </div>
    </div>

    <div class="card settings">
        <h2>‚å®Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î (Hotkeys)</h2>
        <p class="hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        <div class="setting-group">
            <label>‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° (+ Win):</label>
            <input type="text" id="hkPlus" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤..." readonly>
        </div>
        <div class="setting-group">
            <label>‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏î (- Win):</label>
            <input type="text" id="hkMinus" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤..." readonly>
        </div>
    </div>

    <div class="card settings">
        <h2>üîä ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Sound URL)</h2>
        <div class="setting-group">
            <label>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞ (+):</label>
            <input type="text" id="soundWinUrl" value="https://cdn.discordapp.com/attachments/1376544131970764942/1458210723145711757/Guitar_Plink_Slide_13.wav?ex=695ed010&is=695d7e90&hm=96997d98e1feedab17023a3e21fea620569a042bb2cbc916e69d848d538bcaba&">
        </div>
        <div class="setting-group">
            <label>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏î (-):</label>
            <input type="text" id="soundLoseUrl" value="https://cdn.discordapp.com/attachments/1376544131970764942/1458215319830134889/the-loud-house-music_-vibe-link-b.mp3?ex=695ed458&is=695d82d8&hm=5aa663d31f6eb1f7b5fd4ff651beb32e28818ab30e8014452caa86fa582d5ac1&">
        </div>
    </div>

    <div class="card main-stats">
        <div class="stat-group">
            <label>Wins:</label>
            <input type="number" id="currentWinInput" value="0">
        </div>
        <div class="stat-separator">/</div>
        <div class="stat-group">
            <label>Target:</label>
            <input type="number" id="targetWinInput" value="5">
        </div>
    </div>

    <div class="card controls">
        <div class="button-group large-buttons">
            <button id="btnMinus" class="btn btn-danger">-</button>
            <button id="btnPlus" class="btn btn-success">+</button>
        </div>
        <button id="btnReset" class="btn btn-secondary btn-block">Reset</button>
    </div>
</div>

<script>
    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
    const ROOM_TOPIC = 'coolkris_room_999'; 
    const MQTT_HOST = 'wss://broker.emqx.io:8084/mqtt';

    let client;
    let currentWins = 0;
    let targetWins = 5;
    
    // --- 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
    const currentURL = window.location.href;
    const overlayURL = currentURL.substring(0, currentURL.lastIndexOf('/')) + '/overlay.html';
    document.getElementById('overlayLinkInput').value = overlayURL;

    document.getElementById('btnCopy').addEventListener('click', () => {
        const copyText = document.getElementById("overlayLinkInput");
        copyText.select();
        document.execCommand("copy");
        const originalText = document.getElementById('btnCopy').innerText;
        document.getElementById('btnCopy').innerText = "Copied!";
        setTimeout(() => document.getElementById('btnCopy').innerText = originalText, 2000);
    });

    // --- 2. ‡∏£‡∏∞‡∏ö‡∏ö Hotkey ---
    let keyPlus = localStorage.getItem('hk_plus') || '';
    let keyMinus = localStorage.getItem('hk_minus') || '';
    
    document.getElementById('hkPlus').value = keyPlus;
    document.getElementById('hkMinus').value = keyMinus;

    function setupHotkey(inputId, storageKey, type) {
        const el = document.getElementById(inputId);
        el.addEventListener('keydown', (e) => {
            e.preventDefault();
            const code = e.code;
            el.value = code;
            localStorage.setItem(storageKey, code);
            if(type === 'plus') keyPlus = code;
            if(type === 'minus') keyMinus = code;
            el.blur();
        });
    }
    setupHotkey('hkPlus', 'hk_plus', 'plus');
    setupHotkey('hkMinus', 'hk_minus', 'minus');

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.code === keyPlus && keyPlus !== '') doPlus();
        else if (e.code === keyMinus && keyMinus !== '') doMinus();
    });

    // --- 3. ‡∏£‡∏∞‡∏ö‡∏ö MQTT ---
    function connectMQTT() {
        const clientId = 'ctrl_' + Math.random().toString(16).substr(2, 8);
        client = mqtt.connect(MQTT_HOST, { clientId: clientId, clean: true });

        client.on('connect', () => {
            document.getElementById('statusText').innerText = "üü¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
            document.getElementById('statusText').style.color = "#4ade80";
            sendData(null);
        });
        
        client.on('error', (err) => {
            document.getElementById('statusText').innerText = "üî¥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
            document.getElementById('statusText').style.color = "red";
        });
    }

    function sendData(playAudioType = null) {
        if (!client || !client.connected) return;
        const data = JSON.stringify({
            wins: currentWins,
            target: targetWins,
            soundWin: document.getElementById('soundWinUrl').value,
            soundLose: document.getElementById('soundLoseUrl').value,
            playSound: playAudioType 
        });
        client.publish(ROOM_TOPIC, data, { retain: true });
    }

    // --- 4. Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    function doPlus() {
        currentWins++; updateInputs(); sendData('win');
    }
    
    function doMinus() {
        // ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÑ‡∏ß‡πâ)
        currentWins--; 
        updateInputs(); 
        sendData('lose');
    }

    function doReset() {
        currentWins = 0; updateInputs(); sendData(null);
    }

    document.getElementById('btnPlus').addEventListener('click', doPlus);
    document.getElementById('btnMinus').addEventListener('click', doMinus);
    document.getElementById('btnReset').addEventListener('click', doReset);

    const winInput = document.getElementById('currentWinInput');
    const targetInput = document.getElementById('targetWinInput');

    winInput.addEventListener('change', (e) => { currentWins = parseInt(e.target.value)||0; sendData(null); });
    targetInput.addEventListener('change', (e) => { targetWins = parseInt(e.target.value)||1; sendData(null); });

    function updateInputs() {
        winInput.value = currentWins;
        targetInput.value = targetWins;
    }

    connectMQTT();
</script>
</body>
</html>
